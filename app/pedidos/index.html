<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Unikor – Pedidos</title>
  <meta name="theme-color" content="#0ea5a6" />
  <meta name="description" content="Pedido rápido com PDF, histórico por cliente e PWA offline." />

  <!-- garante paths corretos mesmo sem a barra final na URL -->
  <base href="./">

  <!-- Manifest e ícones globais (assets/logo/ na main) -->
  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="/assets/logo/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/logo/apple-touch-icon.png" />

  <!-- CSS -->
  <link rel="stylesheet" href="./css/style.css" />
</head>

<body>
  <!-- HEADER -->
  <header class="hero">
    <div class="hero-inner">
      <div class="hero-left">
        <!-- logo global lida do assets/logo da main -->
        <img class="hero-logo big" src="/assets/logo/unikorbranco-logo.svg" alt="UNIKOR" />
      </div>

      <div class="hero-right">
        <!-- Botão redondo verde “+” -->
        <button id="btnNovoCliente" class="btn-round" title="Novo cliente" aria-label="Adicionar cliente">+</button>
        <!-- Botão Relatórios (como já estava) -->
        <a class="btn-report" href="https://relatorios-seven.vercel.app/">Relatórios</a>
      </div>
    </div>
  </header>

  <div id="offlineBanner" class="offline-banner">OFFLINE — pedidos serão gerados normalmente, mas não serão salvos.</div>

  <main id="appMain">
    <div class="field-group">
      <label for="cliente">Cliente:</label>
      <input list="listaClientes" type="text" id="cliente" autocomplete="off" required />
      <datalist id="listaClientes"></datalist>
    </div>

    <div class="field-group grid-2">
      <div>
        <label for="cnpj">CNPJ:</label>
        <input type="text" id="cnpj" inputmode="numeric" placeholder="00.000.000/0000-00" maxlength="18" />
        <small class="inline-help">Serão salvos apenas dígitos. Validação leve.</small>
      </div>
      <div>
        <label for="ie">Inscrição Estadual:</label>
        <input type="text" id="ie" placeholder="Ex.: ISENTO ou número" />
        <small class="inline-help">Aceita “ISENTO”.</small>
      </div>
    </div>

    <div class="field-group">
      <label for="endereco">Endereço:</label>
      <input type="text" id="endereco" autocomplete="off" required />
      <small class="muted" id="hint-endereco">
        Se for outra cidade, inclua <b>o nome da cidade</b> no fim do endereço.
        Sem cidade, será considerado <b>Porto Alegre - RS</b>.
      </small>
    </div>

    <div class="field-group grid-2">
      <div>
        <label for="contato">Contato (tel/WhatsApp):</label>
        <input type="text" id="contato" inputmode="numeric" placeholder="(00) 00000-0000" maxlength="16" />
      </div>
      <div>
        <label for="cep">CEP:</label>
        <input type="text" id="cep" inputmode="numeric" placeholder="00000-000" maxlength="9" />
      </div>
    </div>

    <div class="field-group">
      <label for="entrega">Data de Entrega:</label>
      <input type="date" id="entrega" required/>
    </div>

    <div class="field-group">
      <label for="horaEntrega">Horário de Entrega:</label>
      <input type="time" id="horaEntrega" required/>
    </div>

    <div class="field-group switch-box">
      <label>Entrega/Retirada:</label>
      <label><input type="radio" name="tipoEntrega" value="ENTREGA" checked> Entrega</label>
      <label><input type="radio" name="tipoEntrega" value="RETIRADA"> Retirada</label>
    </div>

    <div class="field-group">
      <label>Valor do Frete:</label>
      <div class="frete-row">
        <div id="freteValor" class="muted">—</div>
        <label class="inline"><input type="checkbox" id="isentarFrete"/> Isentar frete</label>
      </div>
    </div>

    <div id="itens"></div>
    <button id="adicionarItemBtn">Adicionar Item</button>

    <hr/>
    <label for="pagamento">Forma de Pagamento:</label>
    <select id="pagamento">
      <option value="PIX">PIX</option>
      <option value="DINHEIRO">DINHEIRO</option>
      <option value="CARTÃO (LEVAR MAQUINA)">CARTÃO (LEVAR MAQUINA)</option>
      <option value="OUTRO">OUTRO</option>
    </select>
    <input type="text" id="pagamentoOutro" placeholder="Digite outra forma de pagamento" style="display:none"/>

    <hr/>
    <label for="obsGeral">Observação geral do pedido:</label>
    <textarea id="obsGeral"></textarea>
    <hr/>

    <button class="pdf-btn"  id="btnGerarPdf">Gerar PDF</button>
    <button class="pdf-btn salvar" id="btnSalvarPdf">Salvar PDF</button>
    <button class="pdf-btn compartilhar" id="btnCompartilharPdf">Compartilhar PDF</button>

    <div id="resumo"></div>
  </main>

  <!-- Modal de novo cliente -->
  <div id="clienteModal" class="modal" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="clienteModalTitle">
      <div class="modal-header">
        <h3 id="clienteModalTitle">Novo Cliente</h3>
        <button class="modal-close" type="button" aria-label="Fechar" id="clienteModalFechar">×</button>
      </div>
      <div class="modal-body">
        <div class="field-group">
          <label for="mdCliNome">Nome do Cliente *</label>
          <input id="mdCliNome" type="text" required />
        </div>
        <div class="field-group">
          <label for="mdCliEndereco">Endereço *</label>
          <input id="mdCliEndereco" type="text" required />
          <small class="muted">Inclua a cidade ao fim se não for Porto Alegre - RS.</small>
        </div>
        <div class="field-group grid-2">
          <div>
            <label for="mdCliCnpj">CNPJ</label>
            <input id="mdCliCnpj" type="text" placeholder="00.000.000/0000-00" />
          </div>
          <div>
            <label for="mdCliIE">Inscrição Estadual</label>
            <input id="mdCliIE" type="text" placeholder="Ex.: ISENTO" />
          </div>
        </div>
        <div class="field-group grid-2">
          <div>
            <label for="mdCliContato">Contato (tel/WhatsApp)</label>
            <input id="mdCliContato" type="text" placeholder="(00) 00000-0000" />
          </div>
          <div>
            <label for="mdCliCEP">CEP</label>
            <input id="mdCliCEP" type="text" placeholder="00000-000" />
          </div>
        </div>
        <label class="inline"><input id="mdCliIsento" type="checkbox" /> Isentar frete por padrão</label>
      </div>
      <div class="modal-footer">
        <button id="clienteModalSalvar" class="btn-primary">Salvar</button>
        <button id="clienteModalCancelar" class="btn-secondary">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- jsPDF (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Módulos do app -->
  <script type="module" src="./js/firebase.js"></script>
  <script type="module" src="./js/utils.js"></script>
  <script type="module" src="./js/ui.js"></script>
  <script type="module" src="./js/clientes.js"></script>
  <script type="module" src="./js/frete.js"></script>
  <script type="module" src="./js/pdf.js"></script>
  <script type="module" src="./js/app.js"></script>

  <!-- SW registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const scope = location.pathname.replace(/[^/]+$/, '');
          const reg = await navigator.serviceWorker.register('./sw.js', { scope });

          document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') reg.update();
          });
          setInterval(() => reg.update(), 10 * 60 * 1000);

          reg.addEventListener('updatefound', () => {
            const nw = reg.installing;
            nw && nw.addEventListener('statechange', () => {
              if (nw.state === 'installed' && navigator.serviceWorker.controller) {
                reg.waiting && reg.waiting.postMessage('SKIP_WAITING');
              }
            });
          });

          navigator.serviceWorker.addEventListener('controllerchange', () => {
            if (!window.__reloadedBySW) { window.__reloadedBySW = true; location.reload(); }
          });
        } catch {}
      });
    }

    // Wiring simples do modal (abrir/fechar/emite evento)
    (function(){
      const $ = (s, r=document)=>r.querySelector(s);
      const modal   = $('#clienteModal');
      const openBtn = $('#btnNovoCliente');
      const closeX  = $('#clienteModalFechar');
      const cancel  = $('#clienteModalCancelar');
      const salvar  = $('#clienteModalSalvar');

      function open(){ modal.classList.add('show'); modal.setAttribute('aria-hidden','false'); }
      function close(){ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); }

      openBtn && openBtn.addEventListener('click', open);
      closeX  && closeX.addEventListener('click', close);
      cancel  && cancel.addEventListener('click', close);
      modal.addEventListener('click', (e)=>{ if(e.target===modal) close(); });

      salvar && salvar.addEventListener('click', () => {
        const payload = {
          nome:      $('#mdCliNome')?.value?.trim() || "",
          endereco:  $('#mdCliEndereco')?.value?.trim() || "",
          cnpj:      $('#mdCliCnpj')?.value || "",
          ie:        $('#mdCliIE')?.value || "",
          contato:   $('#mdCliContato')?.value || "",
          cep:       $('#mdCliCEP')?.value || "",
          isentoFrete: !!$('#mdCliIsento')?.checked
        };
        // dispara para quem quiser ouvir (clientes.js pode salvar)
        window.dispatchEvent(new CustomEvent('NovoClienteSubmit', { detail: payload }));
        // também preenche os campos principais, se vazios
        if (payload.nome)     { const c=$('#cliente');  if (c && !c.value) c.value = payload.nome; }
        if (payload.endereco) { const e=$('#endereco'); if (e && !e.value) e.value = payload.endereco; }
        if (payload.cnpj)     { const n=$('#cnpj');     if (n && !n.value) n.value = payload.cnpj; }
        if (payload.ie)       { const i=$('#ie');       if (i && !i.value) i.value = payload.ie; }
        if (payload.cep)      { const p=$('#cep');      if (p && !p.value) p.value = payload.cep; }
        if (payload.contato)  { const t=$('#contato');  if (t && !t.value) t.value = payload.contato; }
        close();
      });
    })();
  </script>

  <datalist id="listaProdutos"></datalist>
</body>
</html>