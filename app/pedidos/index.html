// js/itens.js

let contadorItens = 0;

export function adicionarItem() {
  contadorItens++;
  const container = document.getElementById('itens-container');
  
  const itemDiv = document.createElement('div');
  itemDiv.className = 'item';
  itemDiv.id = `item-${contadorItens}`;
  
  itemDiv.innerHTML = `
    <div class="item-header">
      <h4>Item ${contadorItens}</h4>
      <button type="button" class="remove" onclick="removerItem(${contadorItens})">Remover</button>
    </div>
    
    <div class="field-group">
      <label for="produto-${contadorItens}">Produto/Descrição:</label>
      <input list="listaProdutos" type="text" id="produto-${contadorItens}" class="produto" placeholder="Digite o nome do produto" required />
    </div>
    
    <div class="field-group grid-3">
      <div>
        <label for="quantidade-${contadorItens}">Quantidade:</label>
        <input type="number" id="quantidade-${contadorItens}" class="quantidade" min="0" step="0.01" placeholder="0" />
      </div>
      <div>
        <label for="peso-${contadorItens}">Peso (Kg):</label>
        <input type="number" id="peso-${contadorItens}" class="peso" min="0" step="0.001" placeholder="0.000" />
      </div>
      <div>
        <label for="gramatura-${contadorItens}">Gramatura (g):</label>
        <input type="number" id="gramatura-${contadorItens}" class="gramatura" min="0" placeholder="0" />
        <small class="inline-help">Se informado, peso = qtd × gramatura</small>
      </div>
    </div>
    
    <div class="field-group grid-2">
      <div>
        <label for="valor-${contadorItens}">Valor por Kg:</label>
        <input type="text" id="valor-${contadorItens}" class="valor" placeholder="R$ 0,00" />
      </div>
      <div>
        <label>Subtotal:</label>
        <div id="subtotal-${contadorItens}" class="subtotal">R$ 0,00</div>
      </div>
    </div>
    
    <div class="field-group">
      <label for="obs-${contadorItens}">Observação do item:</label>
      <textarea id="obs-${contadorItens}" class="obs-item" placeholder="Observações específicas deste item..."></textarea>
    </div>
  `;
  
  container.appendChild(itemDiv);
  
  // Adicionar listeners para cálculos automáticos
  configurarCalculosItem(contadorItens);
  
  // Focar no campo produto
  document.getElementById(`produto-${contadorItens}`).focus();
  
  // Atualizar resumo
  atualizarResumo();
}

export function removerItem(id) {
  const item = document.getElementById(`item-${id}`);
  if (item) {
    item.remove();
    atualizarResumo();
  }
}

function configurarCalculosItem(id) {
  const quantidade = document.getElementById(`quantidade-${id}`);
  const peso = document.getElementById(`peso-${id}`);
  const gramatura = document.getElementById(`gramatura-${id}`);
  const valor = document.getElementById(`valor-${id}`);
  
  // Função para calcular subtotal
  const calcular = () => {
    const qtd = parseFloat(quantidade.value) || 0;
    const pesoKg = parseFloat(peso.value) || 0;
    const gram = parseFloat(gramatura.value) || 0;
    const valorKg = parseFloat(valor.value.replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
    
    let pesoFinal = pesoKg;
    
    // Se tem gramatura, calcular peso baseado na quantidade
    if (gram > 0 && qtd > 0) {
      pesoFinal = (qtd * gram) / 1000; // converter para kg
      peso.value = pesoFinal.toFixed(3);
    }
    
    const subtotal = pesoFinal * valorKg;
    document.getElementById(`subtotal-${id}`).textContent = formatarMoeda(subtotal);
    
    atualizarResumo();
  };
  
  // Formatação do valor
  valor.addEventListener('input', (e) => {
    let value = e.target.value.replace(/[^\d]/g, '');
    if (value) {
      value = (parseInt(value) / 100).toFixed(2);
      e.target.value = `R$ ${value.replace('.', ',')}`;
    }
    calcular();
  });
  
  // Listeners para recálculo
  [quantidade, peso, gramatura].forEach(input => {
    input.addEventListener('input', calcular);
  });
}

function formatarMoeda(valor) {
  return new Intl.NumberFormat('pt-BR', {
    style: 'currency',
    currency: 'BRL'
  }).format(valor);
}

function atualizarResumo() {
  const resumoDiv = document.getElementById('resumo');
  const itens = document.querySelectorAll('.item');
  
  let totalItens = 0;
  let pesoTotal = 0;
  let valorTotal = 0;
  
  itens.forEach((item, index) => {
    const id = item.id.split('-')[1];
    const quantidade = parseFloat(document.getElementById(`quantidade-${id}`)?.value) || 0;
    const peso = parseFloat(document.getElementById(`peso-${id}`)?.value) || 0;
    const valor = parseFloat(document.getElementById(`valor-${id}`)?.value.replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
    
    totalItens++;
    pesoTotal += peso;
    valorTotal += peso * valor;
  });
  
  // Adicionar frete se não estiver isento
  const freteIsento = document.getElementById('isentarFrete')?.checked;
  const valorFrete = freteIsento ? 0 : parseFloat(document.getElementById('freteValor')?.textContent.replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
  
  const totalFinal = valorTotal + valorFrete;
  
  resumoDiv.innerHTML = `
    <h3>Resumo do Pedido</h3>
    <div class="resumo-item">
      <span>Total de itens:</span>
      <span>${totalItens}</span>
    </div>
    <div class="resumo-item">
      <span>Peso total:</span>
      <span>${pesoTotal.toFixed(3).replace('.', ',')} kg</span>
    </div>
    <div class="resumo-item">
      <span>Subtotal itens:</span>
      <span>${formatarMoeda(valorTotal)}</span>
    </div>
    ${!freteIsento ? `
    <div class="resumo-item">
      <span>Frete:</span>
      <span>${formatarMoeda(valorFrete)}</span>
    </div>` : ''}
    <div class="resumo-item resumo-total">
      <span>TOTAL GERAL:</span>
      <span>${formatarMoeda(totalFinal)}</span>
    </div>
  `;
}

// Função global para remover item (chamada pelo HTML)
window.removerItem = removerItem;

// Inicialização
document.addEventListener('DOMContentLoaded', () => {
  const btnAdicionar = document.getElementById('adicionarItemBtn');
  if (btnAdicionar) {
    btnAdicionar.addEventListener('click', adicionarItem);
  }
  
  // Adicionar primeiro item automaticamente
  adicionarItem();
});

console.log('Módulo de itens carregado');
