<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Unikor – Pedidos</title>
  <meta name="theme-color" content="#0ea5a6" />
  <meta name="description" content="Pedido rápido com PDF, histórico por cliente e PWA offline." />
  <base href="./">
  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="/assets/logo/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/logo/apple-touch-icon.png" />
  <link rel="stylesheet" href="./css/style.css" />
</head>
<body>
  <!-- HEADER -->
  <header class="hero">
    <div class="hero-inner">
      <div class="hero-left">
        <img class="hero-logo big" src="/assets/logo/unikorbranco-logo.svg" alt="UNIKOR" />
      </div>
      <div class="hero-right">
        <a class="btn-add" id="btnAddCliente" title="Novo cliente">+</a>
        <!-- AJUSTE: rota interna para Relatórios -->
        <a class="btn-report" href="/app/relatorios/">Relatórios</a>
      </div>
    </div>
  </header>

  <div id="offlineBanner" class="offline-banner" style="display:none">
    OFFLINE — pedidos serão gerados normalmente, mas não serão salvos.
  </div>

  <main id="appMain">
    <div class="field-group">
      <label for="cliente">Cliente:</label>
      <input list="listaClientes" type="text" id="cliente" autocomplete="off" required />
      <datalist id="listaClientes"></datalist>
    </div>

    <div class="field-group grid-2">
      <div>
        <label for="cnpj">CNPJ:</label>
        <input type="text" id="cnpj" inputmode="numeric" placeholder="00.000.000/0000-00" maxlength="18" />
        <small class="inline-help">Serão salvos apenas dígitos. Validação leve.</small>
      </div>
      <div>
        <label for="ie">Inscrição Estadual:</label>
        <input type="text" id="ie" placeholder="Ex.: ISENTO ou número" />
        <small class="inline-help">Aceita "ISENTO".</small>
      </div>
    </div>

    <div class="field-group">
      <label for="endereco">Endereço:</label>
      <input type="text" id="endereco" autocomplete="off" required />
      <small class="muted" id="hint-endereco">
        Se for outra cidade, inclua <b>o nome da cidade</b> no fim do endereço.
        Sem cidade, será considerado <b>Porto Alegre - RS</b>.
      </small>
    </div>

    <div class="field-group" id="freteManualGroup" style="display:none">
      <label for="freteManual">Frete Manual (R$):</label>
      <input type="number" id="freteManual" step="0.01" placeholder="Ex: 15.50">
      <small>Deixe vazio para calcular automaticamente</small>
    </div>

    <div class="field-group grid-2">
      <div>
        <label for="contato">Contato (tel/WhatsApp):</label>
        <input type="text" id="contato" inputmode="numeric" placeholder="(00) 00000-0000" maxlength="16" />
      </div>
      <div>
        <label for="cep">CEP:</label>
        <input type="text" id="cep" inputmode="numeric" placeholder="00000-000" maxlength="9" />
      </div>
    </div>

    <div class="field-group">
      <label for="entrega">Data de Entrega:</label>
      <input type="date" id="entrega" required/>
    </div>
    <div class="field-group">
      <label for="horaEntrega">Horário de Entrega:</label>
      <input type="time" id="horaEntrega" required/>
    </div>

    <div class="field-group switch-box">
      <label>Entrega/Retirada:</label>
      <label><input type="radio" name="tipoEntrega" value="ENTREGA" checked> Entrega</label>
      <label><input type="radio" name="tipoEntrega" value="RETIRADA"> Retirada</label>
    </div>

    <div class="field-group">
      <label>Valor do Frete:</label>
      <div class="frete-row">
        <div id="freteValor" class="muted">—</div>
        <label class="inline"><input type="checkbox" id="isentarFrete"/> Isentar frete</label>
      </div>
    </div>

    <div id="itens"></div>
    <button id="adicionarItemBtn">Adicionar Item</button>

    <hr/>

    <label for="pagamento">Forma de Pagamento:</label>
    <select id="pagamento">
      <option value="PIX">PIX</option>
      <option value="DINHEIRO">DINHEIRO</option>
      <option value="CARTÃO (LEVAR MAQUINA)">CARTÃO (LEVAR MAQUINA)</option>
      <option value="OUTRO">OUTRO</option>
    </select>
    <input type="text" id="pagamentoOutro" placeholder="Digite outra forma de pagamento" style="display:none"/>

    <hr/>

    <label for="obsGeral">Observação geral do pedido:</label>
    <textarea id="obsGeral"></textarea>

    <hr/>

    <button class="pdf-btn"  id="btnGerarPdf">Gerar PDF</button>
    <button class="pdf-btn salvar" id="btnSalvarPdf">Salvar PDF</button>
    <button class="pdf-btn compartilhar" id="btnCompartilharPdf">Compartilhar PDF</button>

    <div id="resumo"></div>
  </main>

  <div id="toastBox" class="toast-box"></div>
  <div id="appOverlay" class="overlay hidden"><div class="spinner"></div></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Auth Guard (raiz) -->
  <script type="module" src="/shared/js/auth-guard.js"></script>

  <!-- Módulos do app -->
  <script type="module" src="./js/firebase.js"></script>
  <script type="module" src="./js/utils.js"></script>
  <script type="module" src="./js/ui.js"></script>
  <script type="module" src="./js/itens.js"></script>
  <script type="module" src="./js/clientes.js"></script>
  <script type="module" src="./js/frete.js"></script>
  <script type="module" src="./js/modal-cliente.js"></script>
  <script type="module" src="./js/app.js"></script>

  <!-- SW com auto-update agressivo -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const reg = await navigator.serviceWorker.register('./sw.js', { scope: './' });
          document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') reg.update();
          });
          setInterval(() => reg.update(), 5 * 60 * 1000);
          reg.addEventListener('updatefound', () => {
            const nw = reg.installing;
            nw && nw.addEventListener('statechange', () => {
              if (nw.state === 'installed' && navigator.serviceWorker.controller) {
                reg.waiting && reg.waiting.postMessage('SKIP_WAITING');
              }
            });
          });
          navigator.serviceWorker.addEventListener('controllerchange', () => {
            if (!window.reloadedBySW) { window.reloadedBySW = true; location.reload(); }
          });
        } catch {}
      });
    }
  </script>

<!-- Habilitar espaço no campo Cliente (prioridade máxima; sem travar a digitação) -->
<script>
(function enableSpacesOnCliente(){
  function insertAtCaret(el, txt){
    const start = el.selectionStart ?? el.value.length;
    const end   = el.selectionEnd   ?? el.value.length;
    const v1 = el.value.slice(0, start);
    const v2 = el.value.slice(end);
    el.value = (v1 + txt + v2).replace(/_/g, ' ');
    const pos = start + txt.length;
    try { el.setSelectionRange(pos, pos); } catch {}
    el.dispatchEvent(new Event('input', { bubbles: true }));
  }

  function patch(){
    const el = document.getElementById('cliente');
    if (!el) { requestAnimationFrame(patch); return; }

    el.type = 'text';
    el.setAttribute('inputmode','text');
    el.removeAttribute('pattern');

    const onSpaceKey = (ev) => {
      const isSpace = ev.key === ' ' || ev.code === 'Space';
      if (!isSpace) return;
      insertAtCaret(el, ' ');
      ev.preventDefault();
      ev.stopImmediatePropagation();
      ev.stopPropagation();
    };
    el.addEventListener('keydown',  onSpaceKey, true);
    el.addEventListener('keypress', onSpaceKey, true);

    el.addEventListener('beforeinput', (ev)=>{
      if (ev.inputType === 'insertText' && ev.data === ' ') {
        insertAtCaret(el, ' ');
        ev.preventDefault();
        ev.stopImmediatePropagation();
        ev.stopPropagation();
      }
    }, true);

    el.addEventListener('input', ()=>{
      const caret = el.selectionStart;
      const v = el.value.replace(/_/g, ' ').replace(/\s{2,}/g, ' ');
      if (v !== el.value) {
        el.value = v;
        try { el.setSelectionRange(caret, caret); } catch {}
      }
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', patch);
  } else {
    patch();
  }
})();
</script>
</body>
</html>
