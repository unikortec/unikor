rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ---- Helpers ----
    function isAuthed() { return request.auth != null; }
    function userRole() {
      return isAuthed() && request.auth.token.role != null ? request.auth.token.role : "";
    }
    function isAdmin() {
      return userRole() == "admin" || userRole() == "master";
    }
    function userTenant() {
      return isAuthed() && request.auth.token.tenantId != null ? request.auth.token.tenantId : "";
    }
    function isUpper(s)   { return s is string && s == upper(s); }
    function nonNeg(n)    { return n is number && n >= 0; }
    function validTipo(t) { return t in ["RESFRIADO","CONGELADO"]; }
    function validUnit(u) { return u in ["KG","CX","UN"]; }
    function isServerTime(ts) { return ts is timestamp && ts == request.time; }

    // ---- EXCEÇÃO p/ app Pedidos rodando anônimo no tenant Serra Nobre ----
    function anonAllowedForTenant(tenantId) {
      return request.auth != null
        && request.auth.token.sign_in_provider == "anonymous"
        && tenantId == "serranobrecarnes.com.br";
    }

    // Tudo dentro do namespace tenants
    match /tenants/{tenantId}/{document=**} {

      // Leitura: user do próprio tenant ou master (anônimo liberado nos pontos específicos mais abaixo).
      allow read: if isAuthed() && (tenantId == userTenant() || userRole() == "master");

      // ===== CLIENTES =====
      match /clientes/{clienteId} {
        // Leo (admin/master) e usuários do próprio tenant: ok.
        // Anônimo do tenant "serranobrecarnes.com.br": também ok.
        allow read:    if (isAuthed() && tenantId == userTenant()) || isAdmin() || anonAllowedForTenant(tenantId);
        allow create, update: if (isAuthed() && tenantId == userTenant()) || isAdmin() || anonAllowedForTenant(tenantId);
        // Delete de clientes só admin/master
        allow delete:  if isAdmin() && tenantId == userTenant();

        // Subcoleção de produtos do cliente (permanece admin-only p/ escrita)
        match /produtos/{prodId} {
          allow read:                   if isAuthed() && tenantId == userTenant();
          allow create, update, delete: if isAdmin()  && tenantId == userTenant();
        }
      }

      // ===== HISTÓRICO DE PREÇOS =====
      match /historico_precos/{docId} {
        allow read:    if (isAuthed() && tenantId == userTenant()) || isAdmin() || anonAllowedForTenant(tenantId);
        allow create:  if (isAuthed() && tenantId == userTenant()) || isAdmin() || anonAllowedForTenant(tenantId);
        allow update, delete: if false; // histórico é somente append
      }

      // ===== PEDIDOS =====
      match /pedidos/{pedidoId} {
        // Todos (user do tenant + admin + anônimo do tenant) podem criar/editar/EXCLUIR pedidos
        allow read:    if (isAuthed() && tenantId == userTenant()) || isAdmin() || anonAllowedForTenant(tenantId);
        allow create:  if (isAuthed() && tenantId == userTenant()) || isAdmin() || anonAllowedForTenant(tenantId);
        allow update:  if (isAuthed() && tenantId == userTenant()) || isAdmin() || anonAllowedForTenant(tenantId);
        allow delete:  if (isAuthed() && tenantId == userTenant()) || isAdmin() || anonAllowedForTenant(tenantId);
      }

      // ===== ESTOQUE =====
      match /inventory/{docId} {
        // Liberado a todos os usuários autenticados do tenant; admin mantém poderes
        allow read: if isAuthed() && (tenantId == userTenant() || isAdmin());
        allow create, update: if isAuthed() && (tenantId == userTenant() || isAdmin())
          && isUpper(request.resource.data.family)
          && isUpper(request.resource.data.product)
          && nonNeg(request.resource.data.resfriado_kg)
          && nonNeg(request.resource.data.resfriado_cx)
          && nonNeg(request.resource.data.resfriado_un)
          && nonNeg(request.resource.data.congelado_kg)
          && nonNeg(request.resource.data.congelado_cx)
          && nonNeg(request.resource.data.congelado_un)
          && ("updated_at" in request.resource.data ? isServerTime(request.resource.data.updated_at) : true);
        // Delete do estoque: só admin/master
        allow delete: if isAdmin() && tenantId == userTenant();
      }

      // Movimentações de estoque (history)
      match /history/{docId} {
        allow read: if isAuthed() && (tenantId == userTenant() || isAdmin());
        allow create: if isAuthed() && (tenantId == userTenant() || isAdmin())
          && isUpper(request.resource.data.family)
          && isUpper(request.resource.data.product)
          && validTipo(request.resource.data.tipo)
          && validUnit(request.resource.data.unit)
          && (request.resource.data.qty is number && request.resource.data.qty >= 0)
          && ("at" in request.resource.data ? isServerTime(request.resource.data.at) : true);
        allow update, delete: if false;
      }

      // ===== DESPESAS ===== (liberado a todos os usuários do tenant; delete só admin)
      match /despesas/{docId} {
        allow read: if isAuthed() && (tenantId == userTenant() || isAdmin());
        allow create, update: if isAuthed() && (tenantId == userTenant() || isAdmin());
        allow delete: if isAdmin() && tenantId == userTenant();
      }

      // ===== RELATÓRIOS ===== (apenas leitura; são gerados por consultas)
      match /relatorios/{docId} {
        allow read: if isAuthed() && (tenantId == userTenant() || isAdmin());
        allow write: if false;
      }

      // ===== CRM (somente admin/master) =====
      match /crm_contatos/{docId} {
        allow read, create, update, delete: if isAdmin() && tenantId == userTenant();
      }
      match /crm_leads/{docId} {
        allow read, create, update, delete: if isAdmin() && tenantId == userTenant();
      }

      // ===== DASHBOARD (somente admin/master) =====
      match /metrics/{docId} {
        allow read, write: if isAdmin() && tenantId == userTenant();
      }
    }

    // Bloqueio total fora de /tenants
    match /{document=**} { allow read, write: if false; }
  }
}