<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <base href="./">
  <title>UNIKOR • Portal</title>
  <link rel="manifest" href="manifest.json"/>
  <meta name="theme-color" content="#1e7f46"/>
  <link rel="icon" type="image/png" href="assets/logo/unikor-logo.png">
  <link rel="icon" type="image/svg+xml" href="assets/logo/unikor-logo.svg">
</head>
<body>

  <!-- LOGIN -->
  <section id="scrLogin" class="screen active">
    <div class="container">
      <div class="logo-stack" style="text-align:center; margin:28px 0 14px">
        <div id="logoLogin" style="width:52px;height:52px;margin:0 auto 8px;color:#1e7f46"></div>
        <div class="logo-text">UNIKOR</div>
      </div>

      <div class="login-card">
        <h1>Bem-vindo(a)</h1>
        <label>E-mail</label>
        <input id="email" type="email" placeholder="nome@unikor.com.br" autocomplete="username"/>
        <label>Senha</label>
        <input id="senha" type="password" placeholder="••••••••" autocomplete="current-password"/>
        <button id="btnEntrar" class="btn">Entrar</button>
        <div class="muted">
          <a id="linkEsqueci" href="#" class="link">Esqueci minha senha</a>
        </div>
      </div>
    </div>
  </section>

  <!-- DASHBOARD -->
  <section id="scrDash" class="screen">
    <div class="container" id="dashContainer"></div>
    <div id="fabConfig" class="fab" title="Configurações" style="display:none"></div>
  </section>

  <!-- SCRIPTS -->
  <script type="module" src="./js/ui.js"></script>
  <script type="module" src="./js/icons.js"></script>
  <script type="module" src="./js/firebase.js"></script>
  <script type="module" src="./js/auth.js"></script>

  <script type="module">
    import { injectBaseStyles, renderTopbar } from "./js/ui.js";
    import { Icons } from "./js/icons.js";
    import { $, doLogin, doLogout, doReset, onUser } from "./js/auth.js";

    injectBaseStyles();
    document.getElementById("logoLogin").innerHTML = Icons.logo;

    // login handlers
    document.getElementById("btnEntrar").addEventListener("click", async ()=>{
      const email = document.getElementById("email").value.trim();
      const senha = document.getElementById("senha").value;
      if(!email || !senha){ alert("Informe e-mail e senha."); return; }
      try{ await doLogin(email, senha); }
      catch(e){ alert("Falha ao entrar: " + (e?.message || e)); }
    });

    document.getElementById("linkEsqueci").addEventListener("click", async (ev)=>{
      ev.preventDefault();
      const email = prompt("Qual seu e-mail?");
      if (email){ try{ await doReset(email); alert("E-mail de redefinição enviado."); }
      catch(e){ alert("Não foi possível enviar: " + (e?.message || e)); } }
    });

    // navegação por tile
    document.addEventListener("click",(ev)=>{
      const tile = ev.target.closest(".tile");
      if (tile){ window.location.href = tile.dataset.href; }
    });

    // estado de auth
    onUser(async (user)=>{
      const scrLogin = document.getElementById("scrLogin");
      const scrDash  = document.getElementById("scrDash");
      const fab      = document.getElementById("fabConfig");

      if (!user){
        scrLogin.classList.add("active");
        scrLogin.style.display="block";
        scrDash.classList.remove("active");
        scrDash.style.display="none";
        return;
      }

      const token = await user.getIdTokenResult(true);
      const role = token?.claims?.role || "geral";
      const nomeBase = user.displayName || (user.email?.split("@")[0] || "Usuário");
      const nomeFmt = nomeBase.charAt(0).toUpperCase() + nomeBase.slice(1);

      // topbar
      const container = document.getElementById("dashContainer");
      container.innerHTML = "";
      const topbar = renderTopbar({
        title:"UNIKOR", logoSVG: Icons.logo,
        showLogout:true, onLogout: ()=> doLogout()
      });
      container.appendChild(topbar);
      document.getElementById("bemVindo").textContent = `Bem-vindo(a), ${nomeFmt}`;

      // grid
      const grid = document.createElement("div"); grid.className="grid";
      function tile(href, svg, titulo){
        const el = document.createElement("div");
        el.className="tile"; el.dataset.href=href;
        const icon = document.createElement("div"); icon.innerHTML=svg;
        const label= document.createElement("div"); label.className="tile-title"; label.textContent=titulo;
        el.appendChild(icon); el.appendChild(label);
        return el;
      }
      grid.appendChild(tile("pedidos.html",    Icons.pedidos,    "Pedidos"));
      grid.appendChild(tile("relatorios.html", Icons.relatorios, "Relatórios"));
      grid.appendChild(tile("estoque.html",    Icons.estoque,    "Estoque"));
      grid.appendChild(tile("despesas.html",   Icons.despesas,   "Despesas"));
      grid.appendChild(tile("crm.html",        Icons.crm,        "CRM"));
      grid.appendChild(tile("dashboard.html",  Icons.dashboard,  "Dashboard"));
      container.appendChild(grid);

      // FAB Config (somente MASTER)
      fab.innerHTML = Icons.gearFilled;
      if (role === "master"){
        fab.style.display = "flex";
        fab.classList.add("visible");
        fab.onclick = ()=> window.location.href = "config.html";
      } else {
        fab.style.display = "none";
        fab.classList.remove("visible");
        fab.onclick = null;
      }

      // mostra dashboard
      scrLogin.classList.remove("active"); scrLogin.style.display="none";
      scrDash.classList.add("active");     scrDash.style.display="block";
    });
  </script>
</body>
</html>
